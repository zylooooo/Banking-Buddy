services:
  # SFTP server for testing
  sftp-server:
    build:
      context: ../../../infrastructure/sftp-server
      dockerfile: Dockerfile
    container_name: sftp-server-test
    ports:
      - "2222:22"
    volumes:
      - ../../../infrastructure/sftp-server/data:/home/sftpuser/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 3s
      timeout: 10s
      retries: 10
      start_period: 30s

  # MySQL database for testing replaced with Testcontainers
  # This service is no longer needed - tests now use Testcontainers MySQL
  # which eliminates RDS/Aurora costs

  # Pytest for transaction processor with Testcontainers
  transaction-processor-pytest:
    build:
      context: ../
      dockerfile: tests/Dockerfile.test
    depends_on:
      sftp-server:
        condition: service_healthy
      # Removed mysql-db dependency - using Testcontainers instead
    environment:
      # SFTP server configuration
      - SFTP_HOST=sftp-server
      - SFTP_PORT=22
      - SFTP_USERNAME=sftpuser
      - SFTP_PASSWORD=password123
      - SFTP_REMOTE_FILE=/data/transactions.csv
      - SFTP_LOCAL_FILE=/tmp/transactions.csv
      # Database configuration now handled by Testcontainers
      # No more static database connection - containers created per test
