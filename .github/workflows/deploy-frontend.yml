name: Deploy Frontend

on:
  push:
    branches: [main, integration]
    paths:
      - 'services/frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: ap-southeast-1
  SERVICE_PATH: services/frontend

permissions:
  contents: read    # Required to checkout code

jobs:
  # Job 1: Build (Runs automatically on push)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.SERVICE_PATH }}/package-lock.json
      
      - name: Install dependencies
        run: |
          cd ${{ env.SERVICE_PATH }}
          npm ci
      
      - name: Run linter
        run: |
          cd ${{ env.SERVICE_PATH }}
          npm run lint
      
      - name: Build production bundle
        env:
          # Environment variables from Terraform outputs (or GitHub secrets)
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.VITE_COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ secrets.VITE_COGNITO_CLIENT_ID }}
          VITE_COGNITO_DOMAIN: ${{ secrets.VITE_COGNITO_DOMAIN }}
          VITE_AWS_REGION: ${{ env.AWS_REGION }}
          VITE_REDIRECT_URI: ${{ secrets.VITE_REDIRECT_URI }}
          VITE_LOGOUT_URI: ${{ secrets.VITE_LOGOUT_URI }}
        run: |
          cd ${{ env.SERVICE_PATH }}
          npm run build
      
      - name: Verify build artifacts
        run: |
          if [ ! -f "${{ env.SERVICE_PATH }}/dist/index.html" ]; then
            echo "Error: Build artifacts not found!"
            exit 1
          fi
          ls -lh ${{ env.SERVICE_PATH }}/dist/
          echo "Build completed successfully! âœ…"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.SERVICE_PATH }}/dist/
          retention-days: 7

  # Job 2: Deploy to S3 and CloudFront (Automated for dev, manual approval for staging/prod)
  deploy:
    name: Deploy to S3 and CloudFront
    needs: build
    runs-on: ubuntu-latest
    # Uses GitHub Environments for manual approval on staging/prod
    # Dev deployments are fully automated (no environment protection)
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    env:
      DEPLOY_ENV: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Verify infrastructure exists
        working-directory: infrastructure/terraform
        run: |
          echo "Checking if S3 bucket and CloudFront distribution exist..."
          
          # Initialize Terraform
          if ! terraform init -backend=false; then
            echo "âŒ Failed to initialize Terraform."
            echo "Please check the Terraform configuration and ensure all required files exist."
            exit 1
          fi
          
          # Get outputs with proper error handling
          S3_BUCKET=""
          DIST_ID=""
          
          # Get S3 bucket name
          S3_BUCKET=$(terraform output -raw frontend_s3_bucket_name 2>&1)
          TERRAFORM_EXIT_CODE=$?
          if [ $TERRAFORM_EXIT_CODE -ne 0 ] || [ -z "$S3_BUCKET" ]; then
            echo "âŒ Failed to get S3 bucket name from Terraform outputs."
            echo "Exit code: $TERRAFORM_EXIT_CODE"
            echo "Output: $S3_BUCKET"
            echo "Please ensure infrastructure is provisioned and outputs exist."
            exit 1
          fi
          
          # Get CloudFront distribution ID
          DIST_ID=$(terraform output -raw cloudfront_distribution_id 2>&1)
          TERRAFORM_EXIT_CODE=$?
          if [ $TERRAFORM_EXIT_CODE -ne 0 ] || [ -z "$DIST_ID" ]; then
            echo "âŒ Failed to get CloudFront distribution ID from Terraform outputs."
            echo "Exit code: $TERRAFORM_EXIT_CODE"
            echo "Output: $DIST_ID"
            echo "Please ensure infrastructure is provisioned and outputs exist."
            exit 1
          fi
          
          echo "âœ… Infrastructure verified:"
          echo "  S3 Bucket: $S3_BUCKET"
          echo "  CloudFront Distribution: $DIST_ID"
          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.SERVICE_PATH }}/dist/
      
      - name: Verify artifacts downloaded
        run: |
          if [ ! -f "${{ env.SERVICE_PATH }}/dist/index.html" ]; then
            echo "Error: Build artifacts not found!"
            exit 1
          fi
          echo "âœ… Build artifacts verified"
          ls -lh ${{ env.SERVICE_PATH }}/dist/
      
      - name: Upload to S3
        env:
          S3_BUCKET: ${{ env.S3_BUCKET }}
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "âŒ S3_BUCKET environment variable is not set."
            echo "Please ensure infrastructure verification step completed successfully."
            exit 1
          fi
          
          echo "Uploading files to S3 bucket: $S3_BUCKET"
          
          # Upload all files except index.html (with cache control for static assets)
          aws s3 sync ${{ env.SERVICE_PATH }}/dist/ s3://$S3_BUCKET/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.html"
          
          # Upload index.html with no cache (important for SPA routing)
          aws s3 cp ${{ env.SERVICE_PATH }}/dist/index.html s3://$S3_BUCKET/index.html \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate"
          
          echo "âœ… Files uploaded to S3"
      
      - name: Invalidate CloudFront cache
        env:
          DIST_ID: ${{ env.DIST_ID }}
        run: |
          if [ -z "$DIST_ID" ]; then
            echo "âŒ DIST_ID environment variable is not set."
            echo "Please ensure infrastructure verification step completed successfully."
            exit 1
          fi
          
          echo "Invalidating CloudFront cache for distribution: $DIST_ID"
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "âœ… CloudFront cache invalidation created: $INVALIDATION_ID"
          echo "â³ Waiting for invalidation to complete (this may take a few minutes)..."
          
          aws cloudfront wait invalidation-completed \
            --distribution-id $DIST_ID \
            --id $INVALIDATION_ID
          
          echo "âœ… Cache invalidation completed!"
      
      - name: Get frontend URL
        working-directory: infrastructure/terraform
        run: |
          FRONTEND_URL=$(terraform output -raw frontend_url 2>/dev/null || echo "")
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Frontend URL: $FRONTEND_URL"
          echo ""
          echo "Test the deployment:"
          echo "curl -I $FRONTEND_URL"

